<!DOCTYPE html>
<html lang="fr">
<head>
    <script>
    /*
    ================================================================================
      CHARGEMENT LISTE BADGE
    ================================================================================
    
    ================================================================================
      AVERTISSEMENT - PROTOTYPE
    ================================================================================
      - Propri√©t√© : Ce code est un prototype et reste la propri√©t√© intellectuelle 
        de Fr√©d√©ric Jacquet / AI[4]HumanNexus (https://ai4humannexus.com/).
      - Licence d'utilisation : Il est mis √† la disposition exclusive de 
        l'accueil "Vivienne" de VCA, √† titre gracieux et uniquement pour des 
        fins de test et d'√©valuation.
      - Non-distribution : Ce code ne doit en aucun cas √™tre transmis, copi√© ou 
        distribu√© sans l'autorisation √©crite de son auteur.
      - Absence de garantie : Ce prototype est fourni "en l'√©tat" √† des fins de 
        d√©monstration et n'inclut aucune garantie de maintenance ou de support 
        pour d'√©ventuelles √©volutions.
    ================================================================================
    */
    </script>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="./IMG/F3-favicon.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chargement Liste Badge</title>
    
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #eef1f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            background-color: #ffffff;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            padding: 30px;
            width: 100%;
            max-width: 600px;
        }
        /* Mise √† jour du titre */
        h1 { text-align: center; color: #333; font-size: 1.8rem; margin-bottom: 20px; }
        hr { border: none; height: 1px; background-color: #ddd; margin: 20px 0; }
        .form-section { margin-bottom: 20px; }
        .form-section label { display: block; margin-bottom: 8px; font-weight: 600; color: #555; }
        input[type="text"] {
            width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px;
            font-size: 1rem; box-sizing: border-box; transition: border-color 0.3s, box-shadow 0.3s;
        }
        input[type="text"]:focus { border-color: #007bff; outline: none; box-shadow: 0 0 5px rgba(0, 123, 255, 0.5); }
        .split-inputs { display: flex; gap: 10px; }
        .split-inputs > div { width: 50%; }
        .teams-parser-section { background-color: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; margin-bottom: 20px; }
        .checkbox-label { display: inline-flex; align-items: center; font-weight: normal; }
        .parser-error-message { color: #dc3545; font-size: 0.85em; margin-top: 5px; }
        .hidden { display: none; }
        button {
            cursor: pointer; background-color: #6c757d; color: #fff; border: none; font-weight: bold;
            margin-top: 10px; transition: background-color 0.3s; padding: 10px 15px; border-radius: 8px;
        }
        button:hover { background-color: #5a6268; }
        
        /* Style du nouveau bouton de chargement principal (Vert) */
        .load-main-button {
            display: block; width: 100%; padding: 12px; margin-bottom: 15px;
            background-color: #007bff; /* Bleu pour Badge */
            font-size: 1.1em; font-weight: 700;
        }
        .load-main-button:hover { background-color: #0056b3; }
        
        #result-area {
            text-align: center; font-size: 1.2em; font-weight: bold;
            margin-top: 25px; padding: 15px; border-radius: 8px; min-height: 60px;
            line-height: 1.4;
        }
        #list-status-area {
            text-align: center; font-size: 0.9em; color: #6c757d;
            margin-top: -10px; margin-bottom: 20px; font-style: italic;
        }
        .status-ok { color: #28a745; background-color: #eafaf1; font-size: 1.5em; }
        .status-warning { color: #fd7e14; background-color: #fff8e1; }
        .status-no-list { color: #6c757d; background-color: #f8f9fa; font-size: 1em; }
        .footer-link { text-align: center; margin-top: 2em; font-size: .85em; }
        .footer-link a { color: #7f8c8d; text-decoration: none; }
        .footer-link a:hover { text-decoration: underline; }

        /* Style du bouton flottant CLOSE */
        .close-flottant {
            position: fixed; right: 25px; bottom: 25px; 
            width: 60px; height: 60px;
            background-color: #dc3545; /* Rouge */
            color: white;
            border-radius: 50%; display: flex; align-items: center;
            justify-content: center; font-size: 0.9em; font-weight: bold;
            text-decoration: none; box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 1000; transition: transform 0.2s ease-in-out, background-color 0.2s;
        }
        .close-flottant:hover { 
            transform: scale(1.1); 
            background-color: #c82333; 
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>CHARGEMENT Liste Badge</h1>
        <div id="list-status-area"></div>
        <hr>
        
        <button id="load-list-btn" class="load-main-button">CHARGEMENT DE LA LISTE BADGE</button>
        <input type="file" id="file-input" class="hidden" accept=".csv, .xlsx, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel">
        <div id="recherche-section" class="hidden">
            <div class="teams-parser-section">
                <label class="checkbox-label" for="teams-parser-toggle">
                    <input type="checkbox" id="teams-parser-toggle"> üîç Saisie depuis Teams
                </label>
                <div id="teams-parser-container" class="hidden" style="margin-top: 10px;">
                    <label for="teams-input">Coller le nom complet depuis Teams</label>
                    <input type="text" id="teams-input" placeholder="Ex: NOM Pr√©nom (VCA-FR)">
                    <div id="parser-error-message" class="parser-error-message hidden">Format non reconnu.</div>
                </div>
            </div>

            <div class="form-section split-inputs">
                <div>
                    <label for="nom-destinataire">Nom</label>
                    <input type="text" id="nom-destinataire">
                </div>
                <div>
                    <label for="prenom-destinataire">Pr√©nom</label>
                    <input type="text" id="prenom-destinataire">
                </div>
            </div>

            <button id="verify-btn" class="verify-button">VERIFICATION EQUIPE PIERRES</button>

            <div id="result-area"></div>
            
            <hr>
        </div>
        <div class="footer-link">
          <a href="#" onclick="afficherAvertissement(); return false;">Conditions d'utilisation</a>
        </div>
    </div>
    
    <a href="javascript:void(0);" onclick="window.close()" class="close-flottant" title="Fermer la fen√™tre">CLOSE</a>
    
    <script src="./fonctions_communes.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // R√©f√©rences aux √©l√©ments de chargement
        const loadListBtn = document.getElementById('load-list-btn');
        const fileInput = document.getElementById('file-input');
        const listStatusArea = document.getElementById('list-status-area');
        
        // --- Cl√©s de stockage sp√©cifiques √† la LISTE BADGE ---
        const LIST_STORAGE_KEY = 'listeBadges';
        const FILENAME_KEY = 'listeBadgesFileName';
        const TIMESTAMP_KEY = 'listeBadgesTimestamp';
        // ----------------------------------------------------


        function updateListStatus() {
            const fileName = localStorage.getItem(FILENAME_KEY);
            const timestamp = localStorage.getItem(TIMESTAMP_KEY);
            if (fileName && timestamp) {
                const date = new Date(parseInt(timestamp, 10));
                const dateString = date.toLocaleString('fr-FR', { dateStyle: 'short', timeStyle: 'short' });
                listStatusArea.textContent = `Liste BADGE active : '${fileName}' (charg√©e le ${dateString})`;
            } else {
                listStatusArea.textContent = "Aucune liste BADGE en m√©moire.";
            }
        }

        // Action du clic sur le bouton bleu principal
        loadListBtn.addEventListener('click', () => fileInput.click());

        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const oldTimestamp = localStorage.getItem(TIMESTAMP_KEY);
            if (oldTimestamp && file.lastModified == oldTimestamp) {
                alert("Ce fichier est identique √† celui d√©j√† en m√©moire.\nAucune mise √† jour n'est n√©cessaire.");
                return;
            }

            const reader = new FileReader();
            const processNewList = (newList) => {
                // Stockage de la nouvelle liste
                localStorage.setItem(LIST_STORAGE_KEY, JSON.stringify(newList));
                localStorage.setItem(FILENAME_KEY, file.name);
                localStorage.setItem(TIMESTAMP_KEY, file.lastModified);
                alert(`Liste BADGE mise √† jour avec ${newList.length} entr√©e(s).`);
                updateListStatus();
            };

            if (file.name.endsWith('.xlsx')) {
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        // Conversion en JSON, en utilisant la premi√®re ligne comme header (nomm√© "header: 1")
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: "" });
                        
                        // Si la premi√®re ligne contient "NOM" (c'est un en-t√™te), on la supprime
                        if (jsonData.length > 0 && String(jsonData[0][0]).toUpperCase().includes('NOM')) {
                            jsonData.shift();
                        }
                        
                        // Mappage : on prend Nom (col 0), Pr√©nom (col 1), Soci√©t√© (col 2)
                        const newList = jsonData.map(row => {
                            const nom = (row[0] || '').toString().trim();
                            const prenom = (row[1] || '').toString().trim();
                            const societe = (row[2] || '').toString().trim(); // On stocke la soci√©t√© pour la recherche floue
                            
                            return (nom && prenom) ? {
                                nom: nom.toUpperCase(), // NOM en majuscules pour la recherche
                                prenom: prenom.toUpperCase(), // PRENOM en majuscules
                                societe: societe
                            } : null;
                        }).filter(item => item);
                        
                        processNewList(newList);
                    } catch (error) {
                        alert("Impossible de lire le fichier Excel.");
                    }
                };
                reader.readAsArrayBuffer(file);
            } else { 
                reader.onload = (e) => {
                    const content = e.target.result;
                    const lines = content.split(/\r?\n/);
                    if (lines.length > 0 && lines[0].toUpperCase().includes('NOM')) {
                        lines.shift();
                    }
                    const newList = lines.filter(line => line.trim() !== '').map(line => {
                        const separator = line.includes(';') ? ';' : ',';
                        const colonnes = line.split(separator);
                        
                        if (colonnes.length >= 3) {
                            const nom = colonnes[0].trim();
                            const prenom = colonnes[1].trim();
                            const societe = colonnes[2].trim();
                            
                            return (nom && prenom) ? {
                                nom: nom.toUpperCase(),
                                prenom: prenom.toUpperCase(),
                                societe: societe
                            } : null;
                        }
                        return null;
                    }).filter(item => item);
                    
                    processNewList(newList);
                };
                reader.readAsText(file, 'UTF-8');
            }
        });
        
        updateListStatus();
    });
    </script>
</body>
</html>