<!DOCTYPE html>
<html lang="fr">
<head>
    <script>
    /*
    ================================================================================
      RECEPTION COLIS
    ================================================================================
      
    ================================================================================
      AVERTISSEMENT - PROTOTYPE
    ================================================================================
      - Propri√©t√© : Ce code est un prototype et reste la propri√©t√© intellectuelle 
        de Fr√©d√©ric Jacquet / AI[4]HumanNexus (https://ai4humannexus.com/).
      - Licence d'utilisation : Il est mis √† la disposition exclusive de 
        l'accueil "Vivienne" de VCA, √† titre gracieux et uniquement pour des 
        fins de test et d'√©valuation.
      - Non-distribution : Ce code ne doit en aucun cas √™tre transmis, copi√© ou 
        distribu√© sans l'autorisation √©crite de son auteur.
      - Absence de garantie : Ce prototype est fourni "en l'√©tat" √† des fins de 
        d√©monstration et n'inclut aucune garantie de maintenance ou de support 
        pour d'√©ventuelles √©volutions.
    ================================================================================
    */
    </script>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="./IMG/F3-favicon.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R√©ception Colis/Plis</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #eef1f5; display: flex; justify-content: center; align-items: center;
            min-height: 100vh; margin: 0; padding: 20px; box-sizing: border-box;
        }
        .container {
            background-color: #ffffff; border-radius: 15px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            padding: 30px; width: 100%; max-width: 600px;
        }
        h1 { text-align: center; color: #333; font-size: 1.8rem; margin-bottom: 20px; }
        hr { border: none; height: 1px; background-color: #ddd; margin: 20px 0; }
        .form-section { margin-bottom: 20px; }
        .form-section label { display: block; margin-bottom: 8px; font-weight: 600; color: #555; }
        .input-group, .radio-group, .checkbox-group { display: flex; align-items: center; flex-wrap: wrap; gap: 15px; }
        input[type="text"], input[type="number"], button {
            width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 1rem;
            box-sizing: border-box; transition: border-color 0.3s, box-shadow 0.3s;
        }
        input[type="text"]:focus, input[type="number"]:focus { border-color: #007bff; outline: none; box-shadow: 0 0 5px rgba(0, 123, 255, 0.5); }
        .radio-group label, .checkbox-group label { display: inline-flex; align-items: center; cursor: pointer; font-weight: normal; }
        .checkbox-label { display: inline-flex; align-items: center; font-weight: normal; }
        .radio-group input[type="radio"], .checkbox-group input[type="checkbox"] { margin-right: 5px; }
        .autre-container { margin-top: 10px; width: 100%; }
        .split-inputs { display: flex; gap: 10px; }
        .split-inputs > div { width: 50%; }
        .triplet-inputs { display: flex; gap: 15px; align-items: flex-end; }
        .triplet-inputs > div { width: 31%; }
        .hidden { display: none; }
        .teams-parser-section { background-color: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; margin-bottom: 20px; }
        .parser-error-message { color: #dc3545; font-size: 0.85em; margin-top: 5px; }
        button { cursor: pointer; background-color: #007bff; color: #fff; border: none; font-weight: bold; margin-top: 20px; transition: background-color 0.3s; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #ced4da; cursor: not-allowed; }
        .output-section { margin-top: 25px; padding: 15px; background-color: #f8f9fa; border: 1px dashed #ddd; border-radius: 8px; }
        .output-section h3 { margin-top: 0; font-size: 1.2rem; color: #444; }
        .output-text { word-wrap: break-word; white-space: pre-wrap; background-color: #fff; padding: 10px; border: 1px solid #ccc; border-radius: 5px; margin-bottom: 10px; font-family: monospace; min-height: 50px; }
        .copy-button, .action-button { background-color: #28a745; padding: 8px 12px; font-size: 0.9rem; margin-top: 0; }
        .copy-button:hover, .action-button:hover { background-color: #218838; }
        .action-button { background-color: #17a2b8; }
        .action-button:hover { background-color: #138496; }
        .button-group { display: flex; gap: 10px; }
        .footer-link { text-align: center; margin-top: 2em; font-size: 0.85em; }
        .footer-link a { color: #7f8c8d; text-decoration: none; }
        .footer-link a:hover { text-decoration: underline; }
        .menu-flottant, .clear-flottant { position: fixed; right: 25px; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.9em; font-weight: bold; text-decoration: none; box-shadow: 0 4px 8px rgba(0,0,0,0.2); z-index: 1000; transition: transform 0.2s ease-in-out; }
        .menu-flottant:hover, .clear-flottant:hover { transform: scale(1.1); }
        .menu-flottant { bottom: 25px; background-color: #ced4da; color: #495057; }
        .clear-flottant { bottom: 100px; background-color: #f5c6cb; color: white; }
        #confidential-warning-area {
            background-color: #fff8e1; border: 1px solid #fd7e14; color: #fd7e14;
            padding: 15px; border-radius: 8px; margin-top: 15px; font-weight: bold;
        }
        #confidential-warning-area label { font-weight: normal; display: block; margin-top: 10px; }
        .toast-notification {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #2c3e50;
            color: white;
            padding: 12px 25px;
            border-radius: 25px;
            font-size: 1em;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.4s, visibility 0.4s, bottom 0.4s;
        }
        .toast-notification.show {
            opacity: 1;
            visibility: visible;
            bottom: 50px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>R√©ception Colis/Plis</h1>
        <hr>
        <form id="courrier-form">
            <div class="form-section">
                <label>Soci√©t√© d'exp√©dition*</label>
                <div class="radio-group" id="expedition-group">
                    <label><input type="radio" name="expedition" value="VCA" required> VCA</label>
                    <label><input type="radio" name="expedition" value="BRUNEAU"> BRUNEAU</label>
                    <label><input type="radio" name="expedition" value="DIAMINOR"> DIAMINOR</label>
                    <label><input type="radio" name="expedition" value="DOUANES de Paris"> DOUANES de Paris</label>
                    <label><input type="radio" name="expedition" value="FIDUCIAL"> FIDUCIAL</label>
                    <label><input type="radio" name="expedition" value="Traiteur"> Traiteur</label>
                    <label><input type="radio" name="expedition" value="Inconnu"> Inconnu</label>
                    <label><input type="radio" name="expedition" value="n/a"> n/a</label>
                    <label><input type="radio" name="expedition" value="Autre"> Autre</label>
                </div>
                <div id="expedition-autre-container" class="autre-container hidden">
                    <input type="text" id="expedition-autre-text" placeholder="Pr√©cisez la soci√©t√© d'exp√©dition*">
                </div>
            </div>
            <div class="form-section">
                <label>Soci√©t√© de transport*</label>
                <div class="radio-group" id="transport-group">
                    <label><input type="radio" name="transport" value="AMAZON"> AMAZON</label>
                    <label><input type="radio" name="transport" value="Chronopost"> Chronopost</label>
                    <label><input type="radio" name="transport" value="Colissimo"> Colissimo</label>
                    <label><input type="radio" name="transport" value="Coursier" required> Coursier</label>
                    <label><input type="radio" name="transport" value="DHL"> DHL</label>
                    <label><input type="radio" name="transport" value="DPD"> DPD</label>
                    <label><input type="radio" name="transport" value="FedEx"> FedEx</label>
                    <label><input type="radio" name="transport" value="La Poste"> La Poste</label>
                    <label><input type="radio" name="transport" value="Livreur"> Livreur</label>
                    <label><input type="radio" name="transport" value="TNT"> TNT</label>
                    <label><input type="radio" name="transport" value="UPS"> UPS</label>
                    <label><input type="radio" name="transport" value="Inconnu"> Inconnu</label>
                    <label><input type="radio" name="transport" value="n/a"> n/a</label>
                    <label><input type="radio" name="transport" value="Autre"> Autre</label>
                </div>
                <div id="transport-autre-container" class="autre-container hidden">
                    <input type="text" id="transport-autre-text" placeholder="Pr√©cisez le transporteur*">
                </div>
            </div>
            <hr>
            <div class="teams-parser-section">
                <label class="checkbox-label" for="teams-parser-toggle">
                    <input type="checkbox" id="teams-parser-toggle"> üîç Saisie du destinataire depuis Teams
                </label>
                <div id="teams-parser-container" class="hidden" style="margin-top: 10px;">
                    <label for="teams-input">Coller le nom complet depuis Teams</label>
                    <input type="text" id="teams-input" placeholder="Ex: NOM Pr√©nom (VCA-FR)">
                    <div id="parser-error-message" class="parser-error-message hidden">Format non reconnu.</div>
                </div>
            </div>
            <div class="form-section split-inputs">
                <div>
                    <label for="nom-destinataire">Nom Destinataire</label>
                    <input type="text" id="nom-destinataire" maxlength="25">
                </div>
                <div>
                    <label for="prenom-destinataire">Pr√©nom Destinataire</label>
                    <input type="text" id="prenom-destinataire" maxlength="25">
                </div>
            </div>
            
            <div class="form-section">
                <label class="checkbox-label">
                    <input type="checkbox" id="externe-checkbox"> Contact Externe (pour l'adresse e-mail)
                </label>
            </div>

            <div id="confidential-warning-area" class="hidden">
                <span id="warning-message"></span>
                <label>
                    <input type="checkbox" id="warning-ack-checkbox"> J'ai bien not√© l'avertissement
                </label>
            </div>
            <div class="form-section">
                <label>Destinataire avis√© par*</label>
                <div class="checkbox-group" id="avise-par-group">
                    <label><input type="checkbox" name="avise-par" value="Teams"> Teams</label>
                    <label><input type="checkbox" name="avise-par" value="Mail" checked> Mail</label>
                    <label><input type="checkbox" name="avise-par" value="Tel"> Tel</label>
                    <label><input type="checkbox" name="avise-par" value="n/a"> n/a</label>
                </div>
            </div>
            <div class="form-section">
                <div class="triplet-inputs">
                    <div>
                        <label for="nombre-objets">Total Objets*</label>
                        <input type="number" id="nombre-objets" min="1" max="99" required>
                    </div>
                    <div id="colis-container" class="hidden">
                        <label for="nombre-colis">dont Colis</label>
                        <input type="number" id="nombre-colis" min="0" value="0">
                    </div>
                    <div id="plis-container" class="hidden">
                        <label for="nombre-plis">dont Plis</label>
                        <input type="number" id="nombre-plis" min="0" value="0">
                    </div>
                </div>
            </div>
            <div class="form-section">
                <label>Accept√© √† l'accueil par*</label>
                <div class="radio-group" id="accueil-par-group">
                    <label><input type="radio" name="accueil-par" value="Edwina" required> Edwina</label>
                    <label><input type="radio" name="accueil-par" value="Hassina"> Hassina</label>
                    <label><input type="radio" name="accueil-par" value="Fr√©d√©ric"> Fr√©d√©ric</label>
                    <label><input type="radio" name="accueil-par" value="Accueil"> Accueil</label>
                    <label><input type="radio" name="accueil-par" value="Autre"> Autre</label>
                </div>
                <div id="accueil-par-autre-container" class="autre-container hidden">
                    <input type="text" id="accueil-par-autre-text" placeholder="Pr√©cisez le nom*">
                </div>
            </div>
            <hr>
            <div class="form-section">
                <label for="remarque">Remarques</label>
                <input type="text" id="remarque" maxlength="100">
            </div>
            <button type="submit" id="valider-btn">Valider</button>
        </form>
        <div id="output-area" class="hidden">
            <div class="output-section">
                <h3>Message de notification</h3>
                <div class="output-text" id="notification-message"></div>
                <div class="button-group">
                    <button id="copy-notification-btn" class="copy-button">Copier</button>
                    <button id="mail-btn" class="action-button hidden">Envoyer par mail</button>
                </div>
            </div>
            <div class="output-section">
                <h3>Ligne de donn√©es Excel</h3>
                <div class="output-text" id="excel-line"></div>
                <button id="copy-excel-btn" class="copy-button">Copier la ligne Excel</button>
            </div>
        </div>
        <div class="footer-link">
            <a href="javascript:void(0);" onclick="afficherAvertissement()">Conditions d'utilisation</a>
        </div>
    </div>
    
    <script src="./fonctions_communes.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            ajouterBoutonMenu();
            const clearButton = document.createElement('a');
            clearButton.href = '#'; clearButton.className = 'clear-flottant'; clearButton.textContent = 'CLEAR';
            clearButton.title = "Efface tous les champs";
            clearButton.onclick = (e) => { e.preventDefault(); location.reload(); };
            document.body.appendChild(clearButton);

            const form = document.getElementById('courrier-form');
            const expeditionGroup = document.getElementById('expedition-group');
            const expeditionAutreContainer = document.getElementById('expedition-autre-container');
            const expeditionAutreText = document.getElementById('expedition-autre-text');
            const transportGroup = document.getElementById('transport-group');
            const transportAutreContainer = document.getElementById('transport-autre-container');
            const transportAutreText = document.getElementById('transport-autre-text');
            const teamsParserToggle = document.getElementById('teams-parser-toggle');
            const teamsParserContainer = document.getElementById('teams-parser-container');
            const teamsInput = document.getElementById('teams-input');
            const parserErrorMessage = document.getElementById('parser-error-message');
            const nomDestinataire = document.getElementById('nom-destinataire');
            const prenomDestinataire = document.getElementById('prenom-destinataire');
            const externeCheckbox = document.getElementById('externe-checkbox');
            const nombreObjets = document.getElementById('nombre-objets');
            const colisContainer = document.getElementById('colis-container');
            const plisContainer = document.getElementById('plis-container');
            const nombreColis = document.getElementById('nombre-colis');
            const nombrePlis = document.getElementById('nombre-plis');
            const accueilParGroup = document.getElementById('accueil-par-group');
            const accueilParAutreContainer = document.getElementById('accueil-par-autre-container');
            const accueilParAutreText = document.getElementById('accueil-par-autre-text');
            const outputArea = document.getElementById('output-area');
            const notificationMessage = document.getElementById('notification-message');
            const excelLine = document.getElementById('excel-line');
            const validerBtn = document.getElementById('valider-btn');
            const copyNotificationBtn = document.getElementById('copy-notification-btn');
            const copyExcelBtn = document.getElementById('copy-excel-btn');
            const mailBtn = document.getElementById('mail-btn');
            const warningArea = document.getElementById('confidential-warning-area');
            const warningMessage = document.getElementById('warning-message');
            const warningCheckbox = document.getElementById('warning-ack-checkbox');

            function checkConfidentialiteDestinataire() {
                const nom = nomDestinataire.value;
                const prenom = prenomDestinataire.value;
                if (!nom || !prenom) {
                    warningArea.classList.add('hidden');
                    validerBtn.disabled = false;
                    return;
                }
                const estConfidentiel = verifierSiNomDansListe(nom, prenom);
                if (estConfidentiel) {
                    warningMessage.textContent = `ATTENTION, le destinataire (${prenom} ${nom.toUpperCase()}) fait partie de la liste PIERRES.`;
                    warningArea.classList.remove('hidden');
                    warningCheckbox.checked = false;
                    validerBtn.disabled = true;
                } else {
                    warningArea.classList.add('hidden');
                    validerBtn.disabled = false;
                }
            }
            
            [nomDestinataire, prenomDestinataire].forEach(input => input.addEventListener('input', checkConfidentialiteDestinataire));
            warningCheckbox.addEventListener('change', () => { validerBtn.disabled = !warningCheckbox.checked; });

            const setupRadioToggle = (group, container, textInput) => {
                group.addEventListener('change', (e) => {
                    const isAutre = e.target.value === 'Autre';
                    container.classList.toggle('hidden', !isAutre);
                    textInput.required = isAutre;
                });
            };
            setupRadioToggle(expeditionGroup, expeditionAutreContainer, expeditionAutreText);
            setupRadioToggle(transportGroup, transportAutreContainer, transportAutreText);
            setupRadioToggle(accueilParGroup, accueilParAutreContainer, accueilParAutreText);
            
            function setDefaultObjectCount() {
                nombreObjets.value = 1;
                nombreColis.value = 1;
                nombrePlis.value = 0;
                nombreObjets.dispatchEvent(new Event('input'));
            }

            expeditionGroup.addEventListener('change', (e) => {
                if (e.target.value === 'DOUANES de Paris') {
                    document.querySelector('input[name="transport"][value="Coursier"]').checked = true;
                    nomDestinataire.value = 'WONG';
                    prenomDestinataire.value = 'H√©l√®ne';
                    nombreObjets.value = 1;
                    nombreColis.value = 0;
                    nombrePlis.value = 1;
                    nombreObjets.dispatchEvent(new Event('input'));
                    checkConfidentialiteDestinataire();
                } else {
                    setDefaultObjectCount();
                }
            });

            teamsParserToggle.addEventListener('change', () => {
                teamsParserContainer.classList.toggle('hidden', !teamsParserToggle.checked);
                if (!teamsParserToggle.checked) teamsInput.value = '';
            });

            teamsInput.addEventListener('input', () => {
                const parsedData = parseTeamsName(teamsInput.value);
                if (parsedData) {
                    nomDestinataire.value = parsedData.nom;
                    prenomDestinataire.value = parsedData.prenom;
                    externeCheckbox.checked = parsedData.isExternal;
                    parserErrorMessage.classList.add('hidden');
                    checkConfidentialiteDestinataire();
                } else {
                    parserErrorMessage.classList.remove('hidden');
                }
            });

            nombreObjets.addEventListener('input', () => {
                const total = parseInt(nombreObjets.value, 10) || 0;
                const showDetails = total > 0;
                colisContainer.classList.toggle('hidden', !showDetails);
                plisContainer.classList.toggle('hidden', !showDetails);
                if (showDetails && (parseInt(nombrePlis.value, 10) + parseInt(nombreColis.value, 10) !== total)) {
                    nombreColis.value = total;
                    nombrePlis.value = 0;
                }
            });

            const adjustCounts = (changedInput, otherInput) => {
                const total = parseInt(nombreObjets.value, 10) || 0;
                let changedValue = parseInt(changedInput.value, 10) || 0;
                if (changedValue > total) {
                    changedValue = total;
                    changedInput.value = changedValue;
                }
                otherInput.value = total - changedValue;
            };
            nombrePlis.addEventListener('input', () => adjustCounts(nombrePlis, nombreColis));
            nombreColis.addEventListener('input', () => adjustCounts(nombreColis, nombrePlis));

            form.addEventListener('submit', (e) => {
                e.preventDefault();
                if (!form.reportValidity()) return;
                if (!nomDestinataire.value.trim() && !prenomDestinataire.value.trim()) {
                    alert("Veuillez renseigner au moins le nom ou le pr√©nom du destinataire.");
                    nomDestinataire.focus();
                    return;
                }
                const totalObjets = parseInt(nombreObjets.value, 10);
                const totalPlis = parseInt(nombrePlis.value, 10) || 0;
                const totalColis = parseInt(nombreColis.value, 10) || 0;
                if (totalObjets > 0 && (totalPlis + totalColis !== totalObjets)) {
                    alert("La somme des plis et des colis doit √™tre √©gale au nombre total d'objets.");
                    return;
                }
                if (document.querySelectorAll('input[name="avise-par"]:checked').length === 0) {
                    alert("Veuillez s√©lectionner au moins un moyen pour aviser le destinataire.");
                    return;
                }

                const now = new Date();
                const date = now.toLocaleDateString('fr-FR');
                const time = now.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                let expedition = document.querySelector('input[name="expedition"]:checked').value;
                if (expedition === 'Autre') expedition = expeditionAutreText.value;
                let transport = document.querySelector('input[name="transport"]:checked').value;
                if (transport === 'Autre') transport = transportAutreText.value;
                const nom = nomDestinataire.value;
                const prenom = prenomDestinataire.value;
                const avisePar = Array.from(document.querySelectorAll('input[name="avise-par"]:checked')).map(cb => cb.value).join(', ');
                let accueilPar = document.querySelector('input[name="accueil-par"]:checked').value;
                if (accueilPar === 'Autre') accueilPar = accueilParAutreText.value;
                const remarque = document.getElementById('remarque').value;

                const totalItems = totalColis + totalPlis;
                const verb = (totalItems > 1) ? "ont √©t√©" : "a √©t√©";
                const participle = (totalItems > 1) ? "livr√©s" : "livr√©";
                const pronoun = (totalItems > 1) ? "les " : "l'";
                
                let colisPart = (totalColis > 0) ? (totalColis > 1 ? `${totalColis} colis` : "1 colis") : "";
                let plisPart = (totalPlis > 0) ? (totalPlis > 1 ? `${totalPlis} plis` : "1 pli") : "";
                
                let objetsDesc = "";
                if (colisPart && plisPart) {
                    objetsDesc = `${colisPart} et ${plisPart}`;
                } else {
                    objetsDesc = colisPart || plisPart || `${totalObjets} objet(s)`;
                }

                const prenomPourMessage = prenom.trim() || nom.trim();
                const phrasePrincipale = `Je vous informe que ${objetsDesc} ${verb} ${participle} √† l'accueil √† votre attention.`;
                const phraseSecondaire = `Le Service courrier se chargera de vous ${pronoun}apporter lors de leur prochain passage.`;
                const notification = `Bonjour ${prenomPourMessage},\n\n${phrasePrincipale}\n\n${phraseSecondaire}\n\nBien √† vous,`;
                
                const excelData = [date, time, expedition, transport, nom.toUpperCase(), prenom, avisePar, totalObjets, objetsDesc, accueilPar, '', '', '', remarque].join('\t');
                
                notificationMessage.textContent = notification;
                excelLine.textContent = excelData;
                
                const showMail = avisePar.includes('Mail');
                mailBtn.classList.toggle('hidden', !showMail);

                if (showMail) {
                    const to = construireAdresseEmail(prenom, nom, externeCheckbox.checked);
                    // MODIFICATION : Ajout de la nouvelle adresse en copie
                    const cc = "accueil.vivienne-ext@vancleefarpels.com;service.courrier.vca-ext@vancleefarpels.com";
                    const subject = "Votre colis est arriv√©";
                    const body = encodeURIComponent(notification);
                    mailBtn.onclick = () => window.location.href = `mailto:${to}?cc=${cc}&subject=${subject}&body=${body}`;
                }
                
                outputArea.classList.remove('hidden');
            });

            // MODIFICATION : Remplacement de la fonction de copie
            function showToast(message) {
                const toast = document.createElement('div');
                toast.className = 'toast-notification';
                toast.textContent = message;
                document.body.appendChild(toast);

                setTimeout(() => {
                    toast.classList.add('show');
                }, 10);

                setTimeout(() => {
                    toast.classList.remove('show');
                    toast.addEventListener('transitionend', () => {
                        if (toast.parentNode) {
                            toast.parentNode.removeChild(toast);
                        }
                    });
                }, 2500);
            }

            function copierMessage(elementId) {
                const element = document.getElementById(elementId);
                if (!element || !element.textContent.trim()) {
                    console.error("√âl√©ment √† copier non trouv√© ou vide.");
                    return;
                }
                navigator.clipboard.writeText(element.textContent)
                    .then(() => {
                        showToast('Copi√© dans le presse-papiers !');
                    })
                    .catch(err => {
                        console.error('Erreur lors de la copie : ', err);
                        showToast('Erreur lors de la copie.');
                    });
            }
            
            copyNotificationBtn.addEventListener('click', () => copierMessage('notification-message'));
            copyExcelBtn.addEventListener('click', () => copierMessage('excel-line'));
            
            setDefaultObjectCount();
        });
    </script>
</body>
</html>