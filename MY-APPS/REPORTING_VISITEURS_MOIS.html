<!DOCTYPE html>
<html lang="fr">
<head>
    <script>
    /*
    ================================================================================
      REPORTING VISITEURS MOIS
    ================================================================================
      
    ================================================================================
      AVERTISSEMENT - PROTOTYPE
    ================================================================================
      - Propriété : Ce code est un prototype et reste la propriété intellectuelle 
        de Frédéric Jacquet / AI[4]HumanNexus (https://ai4humannexus.com/).
      - Licence d'utilisation : Il est mis à la disposition exclusive de 
        l'accueil "Vivienne" de VCA, à titre gracieux et uniquement pour des 
        fins de test et d'évaluation.
      - Non-distribution : Ce code ne doit en aucun cas être transmis, copié ou 
        distribué sans l'autorisation écrite de son auteur.
      - Absence de garantie : Ce prototype est fourni "en l'état" à des fins de 
        démonstration et n'inclut aucune garantie de maintenance ou de support 
        pour d'éventuelles évolutions.
    ================================================================================
    */
    </script>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="./IMG/F3-favicon.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporting Visiteurs</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #eef1f5;
            margin: 0;
            padding: 20px;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: auto;
            background-color: #fff;
            padding: 25px 40px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #2c3e50;
        }
        hr {
            border: none;
            height: 1px;
            background-color: #ddd;
            margin: 30px 0;
        }
        .form-section {
            margin-bottom: 25px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        .form-section label {
            font-weight: 600;
            font-size: 1.1rem;
        }
        .form-section input[type="file"], .form-section select, .form-section button {
            font-size: 1rem;
            padding: 8px 12px;
            border-radius: 5px;
            border: 1px solid #ccc;
            width: 100%;
            max-width: 400px;
            cursor: pointer;
        }
        .form-section button {
            background-color: #28a745;
            color: white;
            font-weight: bold;
            border-color: #28a745;
        }
        .form-section button:hover {
            background-color: #218838;
        }
        #chart-container {
            width: 100%;
            margin-top: 30px;
        }
        .hidden { display: none; }
        .footer-link { text-align: center; margin-top: 2em; font-size: 0.85em; }
        .footer-link a { color: #7f8c8d; text-decoration: none; }
        .footer-link a:hover { text-decoration: underline; }
        .menu-flottant {
            position: fixed; bottom: 25px; right: 25px; width: 60px; height: 60px;
            background-color: #ced4da; color: #495057; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.9em; font-weight: bold; text-decoration: none;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2); z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Reporting Visiteurs Mensuel</h1>
        <hr>
        
        <div class="form-section">
            <label for="file-input">1. Choisir un fichier Excel (.xlsx):</label>
            <input type="file" id="file-input" accept=".xlsx, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet">
        </div>

        <div id="sheet-filter-section" class="form-section hidden">
            <label for="sheet-select">Onglet "Suivi Visiteurs" non trouvé. Veuillez choisir l'onglet correct :</label>
            <select id="sheet-select"></select>
        </div>

        <div id="month-filter-section" class="form-section hidden">
            <label for="month-select">2. Choisir un mois:</label>
            <select id="month-select"></select>
        </div>

        <div id="download-section" class="form-section hidden">
            <label for="download-chart-btn">3. Sauvegarder les graphiques:</label>
            <button id="download-daily-btn">Par jour</button>
            <button id="download-hourly-btn">Par heure</button>
        </div>

        <div id="chart-container">
            <canvas id="visitor-chart"></canvas>
        </div>

        <div id="hourly-chart-container" style="margin-top:16px;">
            <h3 id="hourly-title" style="margin:0 0 8px 0;">Répartition par Créneau Horaire</h3>
            <canvas id="hourly-chart"></canvas>
        </div>
        
        <div class="footer-link">
          <a href="#" onclick="afficherAvertissement(); return false;">Conditions d'utilisation</a>
        </div>
    </div>
    
    <script src="./fonctions_communes.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const whiteBackgroundPlugin = {
                id: 'customCanvasBackgroundColor',
                beforeDraw: (chart) => {
                    const ctx = chart.canvas.getContext('2d');
                    ctx.save();
                    ctx.globalCompositeOperation = 'destination-over';
                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, chart.width, chart.height);
                    ctx.restore();
                }
            };
            
            Chart.register(ChartDataLabels, whiteBackgroundPlugin);

            ajouterBoutonMenu();
            let chartInstance = null;
            let hourlyChartInstance = null;
            let allVisits = [];
            let workbook = null; // Pour garder le fichier en mémoire

            const fileInput = document.getElementById('file-input');
            const sheetFilterSection = document.getElementById('sheet-filter-section');
            const sheetSelect = document.getElementById('sheet-select');
            const monthFilterSection = document.getElementById('month-filter-section');
            const monthSelect = document.getElementById('month-select');
            const downloadSection = document.getElementById('download-section');
            const downloadDailyBtn = document.getElementById('download-daily-btn');
            const downloadHourlyBtn = document.getElementById('download-hourly-btn');
            downloadDailyBtn.addEventListener('click', exportDailyPNG);
            downloadHourlyBtn.addEventListener('click', exportHourlyPNG);


            fileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const arrayBuffer = e.target.result;
                            workbook = XLSX.read(arrayBuffer, { type: 'array', cellDates: true });
                            handleSheetSelection();
                        } catch(error) {
                            alert("Un problème est survenu lors de la lecture du fichier Excel.");
                        }
                    };
                    reader.readAsArrayBuffer(file);
                }
            });

            function handleSheetSelection() {
                const sheetNames = workbook.SheetNames;
                const targetSheetName = sheetNames.find(name => name.trim().toLowerCase() === 'suivi visiteurs');

                if (targetSheetName) {
                    sheetFilterSection.classList.add('hidden'); // On cache le sélecteur d'onglet
                    processSheet(targetSheetName);
                } else {
                    sheetFilterSection.classList.remove('hidden');
                    sheetSelect.innerHTML = '<option value="">-- Choisissez un onglet --</option>';
                    sheetNames.forEach(name => {
                        const option = document.createElement('option');
                        option.value = name;
                        option.textContent = name;
                        sheetSelect.appendChild(option);
                    });
                }
            }
            
            sheetSelect.addEventListener('change', () => {
                const selectedSheet = sheetSelect.value;
                if (selectedSheet) {
                    processSheet(selectedSheet);
                }
            });

            monthSelect.addEventListener('change', () => {
                updateChart(monthSelect.value);
                updateHourlyChart(monthSelect.value);
            });

            
            function processSheet(sheetName) {
                const worksheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: "" });
                allVisits = [];

                jsonData.forEach(columns => {
                    if (!columns || columns.length < 1) return;
                    const dateCell = columns[0];
                    let visitDate;
                    if (dateCell instanceof Date && !isNaN(dateCell)) {
                        visitDate = dateCell;
                    } else if (typeof dateCell === 'string' && dateCell.trim()) {
                        let dateParts = dateCell.split('/');
                        if (dateParts.length !== 3) {
                            if (dateCell.includes('-')) {
                                dateParts = dateCell.split('-');
                                if (dateParts[0].length === 4) {
                                    dateParts = [dateParts[2], dateParts[1], dateParts[0]];
                                }
                            } else { return; }
                        }
                        const day = parseInt(dateParts[0], 10);
                        const month = parseInt(dateParts[1], 10) - 1;
                        const year = parseInt(dateParts[2], 10);
                        visitDate = new Date(year, month, day);
                    }
                    if (visitDate && !isNaN(visitDate)) {
                        const timeCell = (columns.length>1)?columns[1]:'';
                        allVisits.push({ date: visitDate, time: timeCell });
                    }
                });

                populateMonthFilter();
                monthSelect.dispatchEvent(new Event('change'));
            }

            function populateMonthFilter() {
                const months = new Set();
                allVisits.forEach(visit => {
                    const month = visit.date.toLocaleString('fr-FR', { month: 'long', year: 'numeric' });
                    months.add(month);
                });

                const sortedMonths = Array.from(months).sort((a, b) => {
                    const [monthA, yearA] = a.split(' ');
                    const [monthB, yearB] = b.split(' ');
                    const dateA = new Date(yearA, ['janvier', 'février', 'mars', 'avril', 'mai', 'juin', 'juillet', 'août', 'septembre', 'octobre', 'novembre', 'décembre'].indexOf(monthA));
                    const dateB = new Date(yearB, ['janvier', 'février', 'mars', 'avril', 'mai', 'juin', 'juillet', 'août', 'septembre', 'octobre', 'novembre', 'décembre'].indexOf(monthB));
                    return dateB - dateA;
                });

                monthSelect.innerHTML = '<option value="">Tous les mois</option>';
                sortedMonths.forEach(month => {
                    const option = document.createElement('option');
                    option.value = month;
                    option.textContent = month.charAt(0).toUpperCase() + month.slice(1);
                    monthSelect.appendChild(option);
                });

                monthFilterSection.classList.remove('hidden');
            }

            
            // ===== Graphique #2 : Répartition par créneau horaire =====
            const HOURLY_LABELS = ["8h-9h","9h-10h","10h-11h","11h-12h","12h-13h","13h-14h","14h-15h","15h-16h","16h-17h","17h-18h","18h-19h"];

            function parseHourFromCell(cellValue) {
                if (cellValue == null) return null;
                if (cellValue instanceof Date && !isNaN(cellValue)) {
                    return cellValue.getHours();
                }
                if (typeof cellValue === 'number' && isFinite(cellValue)) {
                    const h = Math.floor((cellValue % 1) * 24);
                    return (h>=0 && h<=23) ? h : null;
                }
                if (typeof cellValue === 'string') {
                    const s = cellValue.trim();
                    const m = /^\s*(\d{1,2}):(\d{2})(?::(\d{2}))?\s*$/.exec(s);
                    if (!m) return null;
                    const hh = parseInt(m[1],10);
                    const mm = parseInt(m[2],10);
                    if (Number.isInteger(hh) && Number.isInteger(mm) && hh>=0 && hh<=23) return hh;
                    return null;
                }
                return null;
            }

            function computeHourlyBins(filteredVisits) {
                const bins = Array(11).fill(0);
                let total = 0;
                filteredVisits.forEach(v => {
                    const hour = parseHourFromCell(v.time);
                    if (hour!==null && hour>=8 && hour<19) {
                        const idx = hour-8;
                        if (idx>=0 && idx<bins.length) {
                            bins[idx] += 1;
                            total += 1;
                        }
                    }
                });
                return {bins, total};
            }

            function renderOrUpdateHourlyChart(bins, total, selectedMonth) {
                const ctx = document.getElementById('hourly-chart').getContext('2d');
                const titleEl = document.getElementById('hourly-title');
                const period = selectedMonth ? (selectedMonth.charAt(0).toUpperCase()+selectedMonth.slice(1)) : 'Toutes les périodes';
                titleEl.textContent = `Répartition par Créneau Horaire — ${period} — Total : ${total} visite${total>1?'s':''}`;

                if (hourlyChartInstance) hourlyChartInstance.destroy();
                hourlyChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: HOURLY_LABELS,
                        datasets: [{
                            label: 'Visiteurs',
                            data: bins,
                            backgroundColor: 'rgba(40, 167, 69, 0.65)',
                            borderColor: 'rgba(40, 167, 69, 1)',
                            borderWidth: 1,
                            borderRadius: 5
                        }]
                    },
                    options: {
                        plugins: {
                            legend: { display: false },
                            datalabels: {
                                anchor: 'end',
                                align: 'top',
                                formatter: (v) => v>0 ? v : '',
                                font: { weight: 'bold' }
                            }
                        },
                        scales: {
                            y: { beginAtZero: true, ticks: { stepSize: 1 } }
                        }
                    }
                });
            }

            function updateHourlyChart(selectedMonth) {
                const filtered = selectedMonth ? allVisits.filter(v => 
                    v.date.toLocaleString('fr-FR', { month: 'long', year: 'numeric' }) === selectedMonth
                ) : allVisits;
                const {bins, total} = computeHourlyBins(filtered);
                renderOrUpdateHourlyChart(bins, total, selectedMonth);
            }

            function exportDailyPNG() {
                if (chartInstance) {
                    const url = chartInstance.toBase64Image('image/png', 1);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = 'frequentation_par_jour.png';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            }
            function exportHourlyPNG() {
                if (hourlyChartInstance) {
                    const url = hourlyChartInstance.toBase64Image('image/png', 1);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = 'repartition_par_heure.png';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            }
function updateChart(selectedMonth) {
                const filteredVisits = selectedMonth ? allVisits.filter(v => 
                    v.date.toLocaleString('fr-FR', { month: 'long', year: 'numeric' }) === selectedMonth
                ) : allVisits;

                const totalVisitors = filteredVisits.length;

                const visitsByDay = {};
                filteredVisits.forEach(visit => {
                    const day = visit.date.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit' });
                    visitsByDay[day] = (visitsByDay[day] || 0) + 1;
                });

                const sortedDays = Object.keys(visitsByDay).sort((a, b) => {
                    const [dayA, monthA] = a.split('/');
                    const [dayB, monthB] = b.split('/');
                    return new Date(`2000-${monthA}-${dayA}`) - new Date(`2000-${monthB}-${dayB}`);
                });

                const chartData = {
                    labels: sortedDays,
                    datasets: [{
                        label: 'Nombre de Visiteurs par Jour',
                        data: sortedDays.map(day => visitsByDay[day]),
                        backgroundColor: 'rgba(54, 162, 235, 0.6)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1,
                        borderRadius: 5,
                    }]
                };

                if (chartInstance) {
                    chartInstance.destroy();
                }
                
                const periodText = selectedMonth ? (selectedMonth.charAt(0).toUpperCase() + selectedMonth.slice(1)) : 'Toutes les périodes';

                const ctx = document.getElementById('visitor-chart').getContext('2d');
                chartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: chartData,
                    options: {
                        scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } },
                        plugins: {
                            title: {
                                display: true,
                                text: `Fréquentation pour : ${periodText} (Total : ${totalVisitors} visiteurs)`,
                                font: { size: 18 }
                            },
                            datalabels: {
                                anchor: 'end', align: 'top', color: '#333',
                                font: { weight: 'bold' }
                            }
                        }
                    }
                });
                
                downloadSection.classList.remove('hidden');
            }
        });
    </script>
</body>
</html>